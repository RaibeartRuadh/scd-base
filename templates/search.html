{% extends "base.html" %}
[file name]: search.html
[file content begin]
{% block title %}Расширенный поиск танцев - База данных танцев{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="h3 mb-0">Поиск танцев</h1>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm">← Назад к танцам</a>
        </div>

        <!-- Форма поиска -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white py-2">
                <h5 class="mb-0">Параметры поиска</h5>
            </div>
            <div class="card-body py-2">
                <form method="POST" id="searchForm">
                    <div class="row g-2">
                        <!-- Левая колонка -->
                        <div class="col-md-6">
                            <!-- Поиск по названию -->
                            <div class="mb-1">
                                <label for="name" class="form-label small fw-semibold mb-1">Название танца</label>
                                <input type="text" class="form-control form-control-sm" id="name" name="name" 
                                       value="{{ filters.name if filters.name }}"
                                       placeholder="Название или часть названия...">
                            </div>

                            <!-- Поиск по автору -->
                            <div class="mb-1">
                                <label for="author" class="form-label small fw-semibold mb-1">Автор</label>
                                <input type="text" class="form-control form-control-sm" id="author" name="author" 
                                       value="{{ filters.author if filters.author }}"
                                       placeholder="Имя автора...">
                            </div>

                            <!-- Поиск по описанию -->
                            <div class="mb-1">
                                <label for="description" class="form-label small fw-semibold mb-1">Описание танца</label>
                                <input type="text" class="form-control form-control-sm" id="description" name="description" 
                                       value="{{ filters.description if filters.description }}"
                                       placeholder="Текст из описания...">
                            </div>

                            <!-- Публикация -->
                            <div class="mb-1">
                                <label for="published" class="form-label small fw-semibold mb-1">Публикация</label>
                                <input type="text" class="form-control form-control-sm" id="published" name="published" 
                                       value="{{ filters.published if filters.published }}"
                                       placeholder="Название публикации...">
                            </div>

                            <!-- Диапазон тактов и повторений в одной строке -->
                            <div class="row g-1 mb-1">
                                <div class="col-6">
                                    <label class="form-label small fw-semibold mb-1">Такты</label>
                                    <div class="row g-1">
                                        <div class="col-6">
                                            <input type="number" class="form-control form-control-sm" 
                                                   name="size_min" placeholder="Мин"
                                                   value="{{ filters.size_min if filters.size_min }}">
                                        </div>
                                        <div class="col-6">
                                            <input type="number" class="form-control form-control-sm" 
                                                   name="size_max" placeholder="Макс"
                                                   value="{{ filters.size_max if filters.size_max }}">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small fw-semibold mb-1">Повторения</label>
                                    <div class="row g-1">
                                        <div class="col-6">
                                            <input type="number" class="form-control form-control-sm" 
                                                   name="count_min" placeholder="Мин"
                                                   value="{{ filters.count_min if filters.count_min }}">
                                        </div>
                                        <div class="col-6">
                                            <input type="number" class="form-control form-control-sm" 
                                                   name="count_max" placeholder="Макс"
                                                   value="{{ filters.count_max if filters.count_max }}">
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- Правая колонка -->
                        <div class="col-md-6">
                            <!-- Типы танцев -->
                            <div class="mb-1">
                                <label class="form-label small fw-semibold mb-1">Тип танца</label>
                                <div class="filter-scroll-compact">
                                    {% for dance_type in dance_types %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               name="dance_types" value="{{ dance_type.id }}" 
                                               id="type_{{ dance_type.id }}"
                                               {% if filters.dance_types and dance_type.id|string in filters.dance_types %}checked{% endif %}>
                                        <label class="form-check-label small" for="type_{{ dance_type.id }}">
                                            {{ dance_type.name }} ({{ dance_type.code }})
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Форматы и типы сетов в одной строке -->
                            <div class="row g-1 mb-1">
                                <div class="col-6">
                                    <label class="form-label small fw-semibold mb-1">Формат сета</label>
                                    <div class="filter-scroll-compact">
                                        {% for format in dance_formats %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="dance_formats" value="{{ format.id }}" 
                                                   id="format_{{ format.id }}"
                                                   {% if filters.dance_formats and format.id|string in filters.dance_formats %}checked{% endif %}>
                                            <label class="form-check-label small" for="format_{{ format.id }}">
                                                {{ format.name }}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small fw-semibold mb-1">Тип сета</label>
                                    <div class="filter-scroll-compact">
                                        {% for set_type in set_types %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="set_types" value="{{ set_type.id }}" 
                                                   id="set_type_{{ set_type.id }}"
                                                   {% if filters.set_types and set_type.id|string in filters.set_types %}checked{% endif %}>
                                            <label class="form-check-label small" for="set_type_{{ set_type.id }}">
                                                {{ set_type.name }}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <!-- Танцующие пары и наличие материалов в одной строке -->
                            <div class="row g-1 mb-1">
                                <div class="col-6">
                                    <label class="form-label small fw-semibold mb-1">Танцующие пары</label>
                                    <div class="filter-scroll-compact">
                                        {% for couple in dance_couples %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                   name="dance_couples" value="{{ couple[0] }}" 
                                                   id="couple_{{ couple[0] }}"
                                                   {% if filters.dance_couples and couple[0] in filters.dance_couples %}checked{% endif %}>
                                            <label class="form-check-label small" for="couple_{{ couple[0] }}">
                                                {{ couple[0] }}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small fw-semibold mb-1">Наличие материалов</label>
                                    <div class="filter-scroll-compact">
                                        <!-- Чекбокс для наличия описания -->
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                name="has_description" value="on" 
                                                id="has_description"
                                                {% if filters.has_description %}checked{% endif %}>
                                            <label class="form-check-label small" for="has_description">
                                                Есть описание
                                            </label>
                                        </div>
                                        
                                        <!-- Чекбокс для наличия файлов -->
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" 
                                                name="has_files" value="on" 
                                                id="has_files"
                                                {% if filters.has_files %}checked{% endif %}>
                                            <label class="form-check-label small" for="has_files">
                                                Есть файлы
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Кнопки управления -->
                    <div class="row mt-2">
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearForm()">
                                    <i class="fas fa-broom me-1"></i>Очистить
                                </button>
                                <div>
                                    <button type="submit" class="btn btn-primary btn-sm">
                                        <i class="fas fa-search me-1"></i>Поиск
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Статус поиска -->
        {% if results is defined %}
        <div class="alert alert-light border mb-3 py-2">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-info-circle text-primary me-2"></i>
                    <span class="fw-semibold">
                        {% if results %}
                            Найдено танцев: <span class="text-success">{{ total_count }}</span>
                        {% else %}
                            По вашему запросу ничего не найдено
                        {% endif %}
                    </span>
                </div>
                {% if results %}
                <small class="text-muted">Показаны результаты поиска</small>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Результаты поиска -->
        {% if results is defined and results %}
        <!-- Карточки для мобильных устройств -->
        <div class="d-block d-md-none">
            {% for dance in results %}
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-0">
                            <a href="{{ url_for('view_dance', dance_id=dance.id) }}" class="text-decoration-none text-primary fw-bold">
                                {{ dance.name }}
                            </a>
                        </h6>
                        <div class="d-flex align-items-center gap-1">
                            {% if dance.description and dance.description.strip() %}
                            <i class="fas fa-newspaper text-muted small" title="Есть описание танца"></i>
                            {% endif %}
                            {% set dance_files = get_dance_files(dance.id, dance.name) %}
                            {% set dance_images = get_dance_images(dance.id, dance.name) %}
                            {% if dance_files or dance_images %}
                            <i class="fas fa-image text-muted small" title="Есть дополнительные материалы"></i>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-muted">Автор:</small>
                        <span class="ms-1">{{ dance.author or 'Не указан' }}</span>
                    </div>
                    
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <small class="text-muted">Тип танца:</small>
                            {% if dance.dance_type %}
                            <span class="badge badge-type ms-1
                                {% if dance.dance_type.name == 'Reel' %}bg-reel
                                {% elif dance.dance_type.name == 'Jig' %}bg-jig
                                {% elif dance.dance_type.name == 'Strathspey' %}bg-strathspey
                                {% elif dance.dance_type.name == 'Medley' %}bg-medley
                                {% elif dance.dance_type.name == 'Polka' %}bg-polka
                                {% elif dance.dance_type.name == 'March' %}bg-march
                                {% elif dance.dance_type.name == 'Waltz' %}bg-waltz
                                {% elif dance.dance_type.name == 'Hornpipe' %}bg-hornpipe
                                {% elif dance.dance_type.name == 'Quadrille' %}bg-quadrille
                                {% elif dance.dance_type.name == 'Minuet' %}bg-minuet
                                {% else %}bg-secondary{% endif %}">
                                {{ dance.dance_type.name }}
                            </span>
                            {% else %}
                            <span class="text-muted ms-1">-</span>
                            {% endif %}
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Формат сета:</small>
                            <span class="ms-1">{{ dance.dance_format.name if dance.dance_format else '-' }}</span>
                        </div>
                    </div>

                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <small class="text-muted">Тип сета:</small>
                            <span class="ms-1">{{ dance.set_type.name if dance.set_type else '-' }}</span>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Размер:</small>
                            <span class="ms-1 text-muted small">
                                {% if dance.count_id and dance.size_id %}
                                    {{ dance.count_id }}×{{ dance.size_id }}
                                {% elif dance.size_id %}
                                    {{ dance.size_id }} тактов
                                {% else %}
                                    -
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <div class="btn-group btn-group-sm">
                            <a href="{{ url_for('dance_files', dance_id=dance.id) }}" class="btn btn-outline-success btn-sm">
                                <i class="fas fa-folder"></i>
                            </a>
                            <a href="{{ url_for('edit_dance', dance_id=dance.id) }}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-edit"></i>
                            </a>
                        </div>
                        <small class="text-muted align-self-center">
                            ID: {{ dance.id }}
                        </small>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Таблица для десктопов -->
        <div class="d-none d-md-block">
            <div class="card">
                <div class="card-header bg-light py-2 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 text-dark"><i class="fas fa-list me-2"></i>Результаты поиска</h6>
                    <small class="text-muted">Найдено: {{ total_count }}</small>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 table-compact">
                            <thead class="table-dark">
                                <tr>
                                    <th width="30" class="text-center">ID</th>
                                    <th class="text-start">Название</th>
                                    <th class="text-start">Автор</th>
                                    <th class="text-start">Тип танца</th>
                                    <th class="text-start">Тип сета</th>
                                    <th class="text-start">Формат сета</th>
                                    <th class="text-start">Размер</th>
                                    <th width="60" class="text-center">Материалы</th>
                                    <th width="120" class="text-end">Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for dance in results %}
                                <tr class="align-middle">
                                    <td class="text-center">
                                        <small class="text-muted">{{ dance.id }}</small>
                                    </td>
                                    <td class="text-start">
                                        <a href="{{ url_for('view_dance', dance_id=dance.id) }}" class="text-decoration-none fw-bold dance-name">
                                            {{ dance.name }}
                                        </a>
                                    </td>
                                    <td class="text-start">{{ dance.author or '-' }}</td>
                                    <td class="text-start">
                                        {% if dance.dance_type %}
                                        <span class="badge badge-type 
                                            {% if dance.dance_type.name == 'Reel' %}bg-reel
                                            {% elif dance.dance_type.name == 'Jig' %}bg-jig
                                            {% elif dance.dance_type.name == 'Strathspey' %}bg-strathspey
                                            {% elif dance.dance_type.name == 'Medley' %}bg-medley
                                            {% elif dance.dance_type.name == 'Polka' %}bg-polka
                                            {% elif dance.dance_type.name == 'March' %}bg-march
                                            {% elif dance.dance_type.name == 'Waltz' %}bg-waltz
                                            {% elif dance.dance_type.name == 'Hornpipe' %}bg-hornpipe
                                            {% elif dance.dance_type.name == 'Quadrille' %}bg-quadrille
                                            {% elif dance.dance_type.name == 'Minuet' %}bg-minuet
                                            {% else %}bg-secondary{% endif %}">
                                            {{ dance.dance_type.name }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-light text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-start">
                                        {% if dance.set_type %}
                                            <span class="dance-set-type">
                                                {{ dance.set_type.name }}
                                            </span>
                                        {% else %}
                                            <span class="dance-set-type">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-start">
                                        {% if dance.dance_format %}
                                            <span class="dance-format">
                                                {{ dance.dance_format.name }}
                                            </span>
                                        {% else %}
                                            <span class="dance-format">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-start">
                                        {% if dance.count_id and dance.size_id %}
                                            <span class="text-muted dance-size">{{ dance.count_id }}×{{ dance.size_id }}</span>
                                        {% elif dance.size_id %}
                                            <span class="text-muted dance-size">{{ dance.size_id }} тактов</span>
                                        {% else %}
                                            <span class="text-muted dance-size">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="d-flex justify-content-center gap-2">
                                            <!-- Иконка описания (газета) -->
                                            {% if dance.description and dance.description.strip() %}
                                            <i class="fas fa-newspaper material-icon" title="Есть описание танца"></i>
                                            {% endif %}
                                            
                                            <!-- Иконка файлов (картина) -->
                                            {% set dance_files = get_dance_files(dance.id, dance.name) %}
                                            {% set dance_images = get_dance_images(dance.id, dance.name) %}
                                            {% if dance_files or dance_images %}
                                            <i class="fas fa-image material-icon" title="Есть дополнительные материалы"></i>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{{ url_for('dance_files', dance_id=dance.id) }}" class="action-btn action-btn-outline-success" title="Файлы">
                                                <i class="fas fa-folder"></i>
                                            </a>
                                            <a href="{{ url_for('edit_dance', dance_id=dance.id) }}" class="action-btn action-btn-outline-primary" title="Редактировать">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
function clearForm() {
    // Очищаем все текстовые поля
    document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
        input.value = '';
    });
    
    // Снимаем все чекбоксы
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Автоматически отправляем форму после очистки
    document.getElementById('searchForm').submit();
}

// Обработка отправки формы - удаляем пустые поля
document.getElementById('searchForm').addEventListener('submit', function(e) {
    // Находим все текстовые поля
    const textInputs = document.querySelectorAll('input[type="text"]');
    textInputs.forEach(input => {
        if (input.value === '' || input.value === null) {
            input.removeAttribute('name');
        }
    });
    
    // Находим все числовые поля
    const numberInputs = document.querySelectorAll('input[type="number"]');
    numberInputs.forEach(input => {
        if (input.value === '' || input.value === null) {
            input.removeAttribute('name');
        }
    });
    
    // Обрабатываем чекбоксы
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        if (!checkbox.checked) {
            checkbox.removeAttribute('name');
        }
    });
});
</script>

<style>
/* Только специфичные стили для страницы поиска */
.filter-scroll-compact {
    max-height: 80px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 6px;
    background-color: #f8f9fa;
    font-size: 0.75rem;
}

.filter-scroll-compact .form-check {
    margin-bottom: 0.1rem;
}

.filter-scroll-compact .form-check-label {
    font-size: 0.75rem;
}

.form-label.small {
    font-size: 0.75rem;
    margin-bottom: 0.2rem;
}

/* Скрываем все flash-сообщения на странице поиска */
.alert-dismissible {
    display: none !important;
}

/* Компактные отступы для формы */
.card-body.py-2 {
    padding-top: 0.5rem !important;
    padding-bottom: 0.5rem !important;
}

.mb-1 {
    margin-bottom: 0.25rem !important;
}
</style>
{% endblock %}
[file content end]