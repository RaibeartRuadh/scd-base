{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0">Расширенный поиск танцев</h3>
</div>

<div class="row g-4">
    <!-- Левая колонка - Фильтры -->
    <div class="col-lg-3">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-dark text-white py-3">
                <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Фильтры поиска</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('advanced_search') }}" id="searchForm">
                    <!-- Текстовый поиск -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3 border-bottom pb-2">Текстовый поиск</h6>
                        <div class="mb-3">
                            <label class="form-label small">Название танца</label>
                            <input type="text" class="form-control form-control-sm" name="name" value="{{ filters.name }}" 
                                   placeholder="Введите название...">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Автор</label>
                            <input type="text" class="form-control form-control-sm" name="author" value="{{ filters.author }}" 
                                   placeholder="Введите автора...">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Текст в описании</label>
                            <input type="text" class="form-control form-control-sm" name="description_text" value="{{ filters.description_text }}" 
                                   placeholder="Слово или фраза из описания...">
                        </div>
                    </div>

                    <!-- Параметры танца -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3 border-bottom pb-2">Параметры танца</h6>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label small">Тактов в танце</label>
                                <input type="number" class="form-control form-control-sm" name="size_min" value="{{ filters.size_min }}" 
                                       placeholder="Мин." min="0">
                            </div>
                            <div class="col-6">
                                <label class="form-label small">Повторений</label>
                                <input type="number" class="form-control form-control-sm" name="count_min" value="{{ filters.count_min }}" 
                                       placeholder="Мин." min="0">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small">Тип танца</label>
                            <select class="form-select form-select-sm" name="dance_types" multiple size="3">
                                {% for dance_type in dance_types %}
                                <option value="{{ dance_type.id }}" 
                                        {% if dance_type.id|string in filters.dance_types %}selected{% endif %}>
                                    {{ dance_type.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small">Формат сета</label>
                            <select class="form-select form-select-sm" name="dance_formats" multiple size="3">
                                {% for dance_format in dance_formats %}
                                <option value="{{ dance_format.id }}" 
                                        {% if dance_format.id|string in filters.dance_formats %}selected{% endif %}>
                                    {{ dance_format.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small">Тип сета</label>
                            <select class="form-select form-select-sm" name="set_types" multiple size="3">
                                {% for set_type in set_types %}
                                <option value="{{ set_type.id }}" 
                                        {% if set_type.id|string in filters.set_types %}selected{% endif %}>
                                    {{ set_type.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Дополнительные фильтры -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3 border-bottom pb-2">Дополнительно</h6>
                        <div class="mb-3">
                            <label class="form-label small">Танцующие пары</label>
                            <select class="form-select form-select-sm" name="dance_couples" multiple size="3">
                                {% for couple_value, couple_display in dance_couples %}
                                <option value="{{ couple_value }}" 
                                        {% if couple_value in filters.dance_couples %}selected{% endif %}>
                                    {{ couple_display }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small">Наличие материалов</label>
                            <div class="ps-2">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="has_description" 
                                           id="hasDescription" value="on" {% if filters.has_description %}checked{% endif %}>
                                    <label class="form-check-label small" for="hasDescription">
                                        Есть описание
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="has_files" 
                                           id="hasFiles" value="on" {% if filters.has_files %}checked{% endif %}>
                                    <label class="form-check-label small" for="hasFiles">
                                        Есть диаграммы
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="rscds" 
                                           id="rscds" value="on" {% if filters.rscds %}checked{% endif %}>
                                    <label class="form-check-label small" for="rscds">
                                        Публикация RSCDS
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Кнопки управления -->
                    <div class="border-top pt-3">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="fas fa-search me-2"></i>Найти танцы
                            </button>
                            <a href="{{ url_for('advanced_search') }}" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-undo me-2"></i>Сбросить фильтры
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Правая колонка - Результаты -->
    <div class="col-lg-9">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-dark text-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Результаты поиска</h5>
                    {% if results and pagination %}
                    <span class="badge bg-primary">{{ pagination.total }} найдено</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover mb-0 table-compact fixed-columns">
                    <thead class="table-dark">
                        <tr>
                            <th width="40" class="ps-2">ID</th>
                            <th width="300">Название и автор</th>
                            <th width="80">Тип</th>
                            <th width="80">Формат</th>
                            <th width="100">Тип сета</th>
                            <th width="70">Размер</th>
                            <th width="60" class="text-center">Материалы</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if results %}
                            {% for dance in results %}
                            <tr class="align-middle">
                                <td class="ps-2 text-muted small">{{ dance.id }}</td>
                                <td>
                                    <div class="d-flex flex-column">
                                        <a href="{{ url_for('view_dance', dance_id=dance.id) }}" 
                                           class="text-decoration-none fw-bold dance-name text-truncate"
                                           title="{{ dance.name }}">
                                            {{ dance.name }}
                                        </a>
                                        {% if dance.author %}
                                        <small class="text-muted author-text text-truncate" title="{{ dance.author }}">
                                            {{ dance.author }}
                                        </small>
                                        {% endif %}
                                    </div>
                                </td>
                                <!-- Тип танца -->
                                <td>
                                    {% if dance.dance_type %}
                                        <span class="badge badge-type 
                                            {% if dance.dance_type.name == 'Reel' %}bg-reel
                                            {% elif dance.dance_type.name == 'Jig' %}bg-jig
                                            {% elif dance.dance_type.name == 'Strathspey' %}bg-strathspey
                                            {% elif dance.dance_type.name == 'Medley' %}bg-medley
                                            {% elif dance.dance_type.name == 'Polka' %}bg-polka
                                            {% elif dance.dance_type.name == 'March' %}bg-march
                                            {% elif dance.dance_type.name == 'Waltz' %}bg-waltz
                                            {% elif dance.dance_type.name == 'Hornpipe' %}bg-hornpipe
                                            {% elif dance.dance_type.name == 'Quadrille' %}bg-quadrille
                                            {% elif dance.dance_type.name == 'Minuet' %}bg-minuet
                                            {% else %}bg-secondary{% endif %}">
                                            {{ dance.dance_type.name }}
                                        </span>
                                    {% else %}
                                        <span class="badge bg-light text-muted">-</span>
                                    {% endif %}
                                </td>
                                <!-- Формат сета -->
                                <td>
                                    {% if dance.dance_format %}
                                        <span class="dance-format text-truncate d-block" title="{{ dance.dance_format.name }}">
                                            {{ dance.dance_format.name }}
                                        </span>
                                    {% else %}
                                        <span class="dance-format">-</span>
                                    {% endif %}
                                </td>
                                <!-- Тип сета -->
                                <td>
                                    {% if dance.set_type %}
                                        <span class="dance-set-type text-truncate d-block" title="{{ dance.set_type.name }}">
                                            {{ dance.set_type.name }}
                                        </span>
                                    {% else %}
                                        <span class="dance-set-type">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if dance.count_id and dance.size_id %}
                                        <span class="dance-size">
                                            {{ dance.count_id }}×{{ dance.size_id }}
                                        </span>
                                    {% elif dance.size_id %}
                                        <span class="dance-size">
                                            {{ dance.size_id }}
                                        </span>
                                    {% else %}
                                        <span class="dance-size">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <div class="d-flex justify-content-center gap-1">
                                        <!-- Иконка короны для RSCDS танцев -->
                                        {% if dance.rscds %}
                                        <img src="{{ url_for('static', filename='img/crown.png') }}" 
                                             alt="RSCDS" 
                                             class="material-icon" 
                                             title="Танец RSCDS"
                                             style="width: 14px; height: 14px; opacity: 0.8;">
                                        {% endif %}
                                        
                                        <!-- Иконка описания (газета) -->
                                        {% if dance.has_any_description %}
                                        <img src="{{ url_for('static', filename='img/newspaper.png') }}" 
                                             alt="Описание" 
                                             class="material-icon" 
                                             title="Есть описание танца или e-cribs"
                                             style="width: 14px; height: 14px; opacity: 0.8;">
                                        {% endif %}
                                        
                                        <!-- Иконка файлов (картина) -->
                                        {% set dance_files = get_dance_files(dance.id, dance.name) %}
                                        {% set dance_images = get_dance_images(dance.id, dance.name) %}
                                        {% if dance_files or dance_images %}
                                        <img src="{{ url_for('static', filename='img/image.png') }}" 
                                             alt="Файлы" 
                                             class="material-icon" 
                                             title="Есть дополнительные материалы"
                                             style="width: 14px; height: 14px; opacity: 0.8;">
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <div class="py-3">
                                    {% if search_performed %}
                                        <i class="fas fa-search fa-lg text-muted mb-2"></i>
                                        <h6 class="text-muted mb-1">Танцы по заданным фильтрам не найдены</h6>
                                        <p class="text-muted mb-0 small">Попробуйте изменить параметры поиска</p>
                                    {% else %}
                                        <i class="fas fa-filter fa-lg text-muted mb-2"></i>
                                        <h6 class="text-muted mb-1">Задайте параметры поиска</h6>
                                        <p class="text-muted mb-0 small">Используйте фильтры слева для поиска танцев</p>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Пагинация -->
        {% if results and pagination and pagination.pages > 1 %}
        <div class="mt-4">
            <nav aria-label="Навигация по страницам">
                <ul class="pagination justify-content-center pagination-sm">
                    {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ build_pagination_url(pagination.prev_num) }}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link"><i class="fas fa-chevron-left"></i></span>
                    </li>
                    {% endif %}

                    {% for page_num in pagination.iter_pages(left_edge=1, left_current=2, right_current=2, right_edge=1) %}
                        {% if page_num %}
                            <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                                <a class="page-link" href="{{ build_pagination_url(page_num) }}">{{ page_num }}</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}

                    {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ build_pagination_url(pagination.next_num) }}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link"><i class="fas fa-chevron-right"></i></span>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            
            <div class="text-center text-muted small mt-2">
                Страница {{ pagination.page }} из {{ pagination.pages }} • 
                Показано {{ results|length }} из {{ pagination.total }} танцев
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
/* ===== ФИКСИРОВАННАЯ ШИРИНА СТОЛБЦОВ ===== */
.table-compact.fixed-columns {
    table-layout: fixed;
    width: 100%;
}

/* Принудительная установка ширины для всех столбцов */
.table-compact.fixed-columns th:nth-child(1),
.table-compact.fixed-columns td:nth-child(1) {
    width: 40px;
    min-width: 40px;
    max-width: 40px;
}

.table-compact.fixed-columns th:nth-child(2),
.table-compact.fixed-columns td:nth-child(2) {
    width: 300px;
    min-width: 300px;
    max-width: 300px;
}

.table-compact.fixed-columns th:nth-child(3),
.table-compact.fixed-columns td:nth-child(3) {
    width: 80px;
    min-width: 80px;
    max-width: 80px;
}

.table-compact.fixed-columns th:nth-child(4),
.table-compact.fixed-columns td:nth-child(4) {
    width: 80px;
    min-width: 80px;
    max-width: 80px;
}

.table-compact.fixed-columns th:nth-child(5),
.table-compact.fixed-columns td:nth-child(5) {
    width: 100px;
    min-width: 100px;
    max-width: 100px;
}

.table-compact.fixed-columns th:nth-child(6),
.table-compact.fixed-columns td:nth-child(6) {
    width: 70px;
    min-width: 70px;
    max-width: 70px;
}

.table-compact.fixed-columns th:nth-child(7),
.table-compact.fixed-columns td:nth-child(7) {
    width: 60px;
    min-width: 60px;
    max-width: 60px;
}

/* Обрезка длинного текста */
.table-compact.fixed-columns td {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Специальные стили для колонки с названием и автором */
.table-compact.fixed-columns td:nth-child(2) {
    white-space: normal;
    overflow: hidden;
}

.table-compact.fixed-columns td:nth-child(2) .d-flex {
    min-height: 32px;
    justify-content: center;
    flex-direction: column;
}

/* ===== СТИЛИ ДЛЯ ИКОНОК МАТЕРИАЛОВ ===== */
.material-icon {
    cursor: default;
    transition: all 0.2s ease;
    opacity: 0.8;
}

.material-icon:hover {
    opacity: 1;
    transform: scale(1.1);
}

/* ===== ВЫРАВНИВАНИЕ ПО ЦЕНТРУ ===== */
.table-compact td.text-center > * {
    justify-content: center;
}

/* ===== КОМПАКТНЫЕ ОТСТУПЫ ДЛЯ ГРУППЫ ИКОНОК ===== */
.d-flex.gap-1 {
    gap: 0.15rem !important;
}

/* ===== ОСНОВНЫЕ СТИЛИ ТАБЛИЦЫ ===== */
.table-compact td {
    padding: 3px 4px;
    font-size: 0.75rem;
    vertical-align: middle;
    height: 28px;
}

.table-compact th {
    padding: 6px 4px;
    font-size: 0.7rem;
    vertical-align: middle;
    font-weight: 600;
}

/* ===== СТИЛИ ДЛЯ НАЗВАНИЯ ТАНЦА ===== */
.dance-name {
    font-weight: 600 !important;
    color: var(--primary-color) !important;
    font-size: 0.8rem;
    line-height: 1.1;
    margin-bottom: 1px;
}

.dance-name:hover {
    color: #0a58ca !important;
    text-decoration: underline !important;
}

.author-text {
    font-size: 0.7rem;
    color: #6c757d !important;
    line-height: 1;
}

/* ===== СТИЛИ ДЛЯ БЕЙДЖЕЙ ТИПОВ ТАНЦЕВ ===== */
.badge-type {
    font-size: 0.65rem;
    padding: 0.15rem 0.3rem;
    vertical-align: middle;
    display: inline-block;
    line-height: 1;
    font-weight: 600;
    min-width: 60px;
    text-align: center;
    border-radius: 6px;
}

/* Бледные цвета для типов танцев */
.bg-reel {
    background-color: var(--reel-color) !important;
    color: var(--reel-text) !important;
}

.bg-jig {
    background-color: var(--jig-color) !important;
    color: var(--jig-text) !important;
}

.bg-strathspey {
    background-color: var(--strathspey-color) !important;
    color: var(--strathspey-text) !important;
}

.bg-medley {
    background-color: var(--medley-color) !important;
    color: var(--medley-text) !important;
}

.bg-polka {
    background-color: var(--polka-color) !important;
    color: var(--polka-text) !important;
}

.bg-march {
    background-color: var(--march-color) !important;
    color: var(--march-text) !important;
}

.bg-waltz {
    background-color: var(--waltz-color) !important;
    color: var(--waltz-text) !important;
}

.bg-hornpipe {
    background-color: var(--hornpipe-color) !important;
    color: var(--hornpipe-text) !important;
}

.bg-quadrille {
    background-color: var(--quadrille-color) !important;
    color: var(--quadrille-text) !important;
}

.bg-minuet {
    background-color: var(--minuet-color) !important;
    color: var(--minuet-text) !important;
}

/* ===== СТИЛИ ДЛЯ РАЗМЕРА ТАНЦА ===== */
.dance-size {
    font-size: 0.7rem;
    vertical-align: middle;
    display: inline-block;
    line-height: 1;
    color: #6c757d;
    font-weight: 500;
}

.dance-format, .dance-set-type {
    font-size: 0.7rem;
    color: #6c757d;
    font-weight: 500;
}

/* ===== СТИЛИ ДЛЯ ID ТАНЦА ===== */
.text-muted.small {
    font-size: 0.7rem;
    color: #6c757d !important;
}

/* ===== ВЫРАВНИВАНИЕ ЭЛЕМЕНТОВ В ТАБЛИЦЕ ===== */
.table-compact td > * {
    vertical-align: middle;
}

/* ===== АДАПТИВНОСТЬ ===== */
@media (max-width: 991.98px) {
    .col-lg-3 {
        margin-bottom: 1.5rem;
    }
    
    .table-compact td,
    .table-compact th {
        padding: 2px 3px;
        font-size: 0.7rem;
    }
    
    .dance-name {
        font-size: 0.75rem;
    }
    
    .author-text {
        font-size: 0.65rem;
    }
    
    .badge-type {
        font-size: 0.6rem;
        padding: 0.1rem 0.25rem;
        min-width: 55px;
    }

    .material-icon {
        width: 12px !important;
        height: 12px !important;
    }
}

@media (max-width: 767.98px) {
    .card-body {
        padding: 1rem;
    }
    
    .form-select[multiple] {
        min-height: 60px;
    }
}
</style>

<script>
// Автоматическая отправка формы при изменении фильтров
document.addEventListener('DOMContentLoaded', function() {
    const autoSubmitElements = document.querySelectorAll('select[multiple], input[type="checkbox"]');
    
    autoSubmitElements.forEach(element => {
        element.addEventListener('change', function() {
            setTimeout(() => {
                document.getElementById('searchForm').submit();
            }, 300);
        });
    });
});
</script>
{% endblock %}