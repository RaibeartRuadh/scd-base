{% extends "base.html" %}

{% block title %}Расширенный поиск танцев - База данных танцев{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="h3 mb-0">Поиск танцев</h1>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm">← Назад к танцам</a>
        </div>

        <!-- Форма поиска -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white py-2">
                <h5 class="mb-0">Параметры поиска</h5>
            </div>
            <div class="card-body py-3">
                <form method="POST" id="searchForm">
                    <div class="row g-3">
                        <!-- Левая колонка -->
                        <div class="col-md-6">
                            <!-- Поиск по названию -->
                            <div class="mb-2">
                                <label for="name" class="form-label small fw-semibold">Название танца</label>
                                <input type="text" class="form-control form-control-sm" id="name" name="name" 
                                       value="{{ filters.name if filters.name }}"
                                       placeholder="Название или часть названия...">
                            </div>

                            <!-- Поиск по автору -->
                            <div class="mb-2">
                                <label for="author" class="form-label small fw-semibold">Автор</label>
                                <input type="text" class="form-control form-control-sm" id="author" name="author" 
                                       value="{{ filters.author if filters.author }}"
                                       placeholder="Имя автора...">
                            </div>

                            <!-- Поиск по описанию -->
                            <div class="mb-2">
                                <label for="description" class="form-label small fw-semibold">Описание танца</label>
                                <input type="text" class="form-control form-control-sm" id="description" name="description" 
                                       value="{{ filters.description if filters.description }}"
                                       placeholder="Текст из описания...">
                            </div>

                            <!-- Танцующие пары -->
                            <div class="mb-2">
                                <label for="dance_couples" class="form-label small fw-semibold">Танцующие пары</label>
                                <input type="number" class="form-control form-control-sm" id="dance_couples" name="dance_couples" 
                                       value="{{ filters.dance_couples if filters.dance_couples }}"
                                       min="0" placeholder="Количество пар...">
                            </div>
                        </div>

                        <!-- Правая колонка -->
                        <div class="col-md-6">
                            <!-- Типы танцев -->
                            <div class="mb-2">
                                <label class="form-label small fw-semibold">Тип танца</label>
                                <div class="filter-scroll" style="max-height: 120px; overflow-y: auto;">
                                    {% for dance_type in dance_types %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               name="dance_types" value="{{ dance_type.id }}" 
                                               id="type_{{ dance_type.id }}"
                                               {% if dance_type.id|string in filters.dance_types %}checked{% endif %}>
                                        <label class="form-check-label small" for="type_{{ dance_type.id }}">
                                            {{ dance_type.name }} ({{ dance_type.code }})
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Форматы сетов -->
                            <div class="mb-2">
                                <label for="dance_formats" class="form-label small fw-semibold">Формат сета</label>
                                <select class="form-select form-select-sm" id="dance_formats" name="dance_formats">
                                    <option value="">Все форматы</option>
                                    {% for format in dance_formats %}
                                    <option value="{{ format.id }}" 
                                            {% if format.id|string == filters.dance_formats %}selected{% endif %}>
                                        {{ format.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Типы сетов -->
                            <div class="mb-2">
                                <label for="set_types" class="form-label small fw-semibold">Тип сета</label>
                                <select class="form-select form-select-sm" id="set_types" name="set_types">
                                    <option value="">Все типы сетов</option>
                                    {% for set_type in set_types %}
                                    <option value="{{ set_type.id }}" 
                                            {% if set_type.id|string == filters.set_types %}selected{% endif %}>
                                        {{ set_type.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Количество тактов -->
                            <div class="mb-2">
                                <label for="size" class="form-label small fw-semibold">Количество тактов</label>
                                <input type="number" class="form-control form-control-sm" id="size" name="size" 
                                       value="{{ filters.size if filters.size }}"
                                       min="0" placeholder="Количество тактов...">
                            </div>

                            <!-- Публикация -->
                            <div class="mb-2">
                                <label for="published" class="form-label small fw-semibold">Публикация</label>
                                <input type="text" class="form-control form-control-sm" id="published" name="published" 
                                       value="{{ filters.published if filters.published }}"
                                       placeholder="Название публикации...">
                            </div>
                        </div>
                    </div>

                    <!-- Кнопки управления -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearForm()">
                                    <i class="fas fa-broom me-1"></i>Очистить
                                </button>
                                <div>
                                    <button type="submit" class="btn btn-primary btn-sm">
                                        <i class="fas fa-search me-1"></i>Поиск
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Статус поиска -->
        {% if results is defined %}
        <div class="alert alert-light border mb-3 py-2">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-info-circle text-primary me-2"></i>
                    <span class="fw-semibold">
                        {% if results %}
                            Найдено танцев: <span class="text-success">{{ total_count }}</span>
                        {% else %}
                            По вашему запросу ничего не найдено
                        {% endif %}
                    </span>
                </div>
                {% if results %}
                <small class="text-muted">Показаны результаты поиска</small>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Результаты поиска -->
        {% if results is defined and results %}
        <div class="card">
            <div class="card-header bg-light py-2">
                <h6 class="mb-0 text-dark"><i class="fas fa-list me-2"></i>Результаты поиска</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 table-compact">
                        <thead class="table-dark">
                            <tr>
                                <th class="px-3 text-start">Название</th>
                                <th class="px-3 text-start">Автор</th>
                                <th class="px-3 text-start">Тип</th>
                                <th class="px-3 text-start">Размер</th>
                                <th class="px-3 text-start">Формат</th>
                                <th class="px-3 text-end">Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dance in results %}
                            <tr class="align-middle">
                                <td class="px-3 text-start">
                                    <a href="{{ url_for('view_dance', dance_id=dance.id) }}" 
                                       class="text-decoration-none fw-bold text-primary dance-name">
                                        {{ dance.name }}
                                    </a>
                                </td>
                                <td class="px-3 text-start">{{ dance.author or '-' }}</td>
                                <td class="px-3 text-start">
                                    {% if dance.dance_type_rel %}
                                    <span class="badge badge-type 
                                        {% if dance.dance_type_rel.name == 'Reel' %}bg-primary
                                        {% elif dance.dance_type_rel.name == 'Jig' %}bg-success
                                        {% elif dance.dance_type_rel.name == 'Strathspey' %}bg-warning text-dark
                                        {% else %}bg-secondary{% endif %}">
                                        {{ dance.dance_type_rel.name }}
                                    </span>
                                    {% else %}
                                    <span class="badge bg-light text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 text-start">
                                    {% if dance.count_id and dance.size_id %}
                                        <span class="text-muted small dance-size">{{ dance.count_id }}×{{ dance.size_id }}</span>
                                    {% elif dance.size_id %}
                                        <span class="text-muted small dance-size">{{ dance.size_id }} тактов</span>
                                    {% else %}
                                        <span class="text-muted small dance-size">-</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 text-start">{{ dance.dance_format_rel.name if dance.dance_format_rel else '-' }}</td>
                                <td class="px-3 text-end">
                                    <div class="btn-group btn-group-sm justify-content-end" role="group">
                                        <a href="{{ url_for('dance_files', dance_id=dance.id) }}" 
                                           class="btn btn-outline-success btn-icon" title="Файлы">
                                            <i class="fas fa-folder"></i>
                                        </a>
                                        <a href="{{ url_for('edit_dance', dance_id=dance.id) }}" 
                                           class="btn btn-outline-primary btn-icon" title="Редактировать">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
function clearForm() {
    // Очищаем все текстовые поля
    document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => {
        input.value = '';
    });
    
    // Снимаем все чекбоксы
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Сбрасываем выпадающие списки
    document.querySelectorAll('select').forEach(select => {
        select.selectedIndex = 0;
    });
    
    // Автоматически отправляем форму после очистки
    document.getElementById('searchForm').submit();
}

// Обработка отправки формы - удаляем пустые поля
document.getElementById('searchForm').addEventListener('submit', function(e) {
    // Находим все текстовые поля (включая description)
    const textInputs = document.querySelectorAll('input[type="text"]');
    textInputs.forEach(input => {
        if (input.value === '' || input.value === null) {
            input.removeAttribute('name');
        }
    });
    
    // Находим все числовые поля
    const numberInputs = document.querySelectorAll('input[type="number"]');
    numberInputs.forEach(input => {
        if (input.value === '' || input.value === null) {
            input.removeAttribute('name');
        }
    });
    
    // Обрабатываем выпадающие списки
    const selects = document.querySelectorAll('select');
    selects.forEach(select => {
        if (select.value === '' || select.value === null) {
            select.removeAttribute('name');
        }
    });
    
    // Обрабатываем чекбоксы
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        if (!checkbox.checked) {
            checkbox.removeAttribute('name');
        }
    });
});
</script>

<style>
.filter-scroll {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 8px;
    background-color: #f8f9fa;
    font-size: 0.8rem;
}

.form-check {
    margin-bottom: 0.2rem;
}

.form-check-label {
    font-size: 0.8rem;
}

.form-label {
    font-weight: 600;
    margin-bottom: 0.3rem;
}

.card {
    border-radius: 8px;
    border: 1px solid #e0e0e0;
}

.card-header {
    border-radius: 8px 8px 0 0 !important;
}
/* Скрываем все flash-сообщения на странице поиска */
.alert-dismissible {
    display: none !important;
}
/* Стили для компактной таблицы результатов */
.table-compact td {
    padding: 8px 10px;
    font-size: 0.82rem;
    vertical-align: middle;
    height: 40px;
}

.table-compact th {
    padding: 10px;
    font-size: 0.78rem;
    vertical-align: middle;
}

/* Стили для названий танцев */
.dance-name {
    font-weight: 600 !important;
    color: #0d6efd !important;
    font-size: 0.85rem;
    line-height: 1.2;
}

.dance-name:hover {
    color: #0a58ca !important;
    text-decoration: underline !important;
}

/* Выравнивание элементов в ячейках */
.badge-type {
    font-size: 0.65rem;
    padding: 0.25rem 0.5rem;
    vertical-align: middle;
    display: inline-block;
    line-height: 1;
}

.dance-size {
    font-size: 0.75rem;
    vertical-align: middle;
    display: inline-block;
    line-height: 1.2;
}

.btn-icon {
    padding: 0.2rem 0.35rem;
    border-radius: 4px;
    font-size: 0.7rem;
    transition: all 0.2s ease;
    vertical-align: middle;
}

.btn-icon:hover {
    transform: translateY(-1px);
}

/* Гарантия выравнивания по вертикали */
.table-compact td > * {
    vertical-align: middle;
}

/* Компактные стили для алерта */
.alert {
    font-size: 0.875rem;
    margin-bottom: 1rem;
}

/* Выравнивание текста в таблице */
.table-compact th.text-start,
.table-compact td.text-start {
    text-align: left;
}

.table-compact th.text-end,
.table-compact td.text-end {
    text-align: right;
}

/* Выравнивание группы кнопок по правому краю */
.btn-group.justify-content-end {
    width: auto;
    margin-left: auto;
}
</style>
{% endblock %}