{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0">Расширенный поиск танцев</h3>
</div>

<div class="row g-4">
    <!-- Левая колонка - Фильтры -->
    <div class="col-lg-3">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-dark text-white py-3">
                <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Фильтры поиска</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('advanced_search') }}" id="searchForm">
                    <input type="hidden" name="search_submitted" value="true">
                    
                    <!-- Текстовый поиск -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3 border-bottom pb-2">Текстовый поиск</h6>
                        <div class="mb-3">
                            <label class="form-label small">Название танца</label>
                            <input type="text" class="form-control form-control-sm" name="name" value="{{ filters.name }}" 
                                   placeholder="Введите название...">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Автор</label>
                            <input type="text" class="form-control form-control-sm" name="author" value="{{ filters.author }}" 
                                   placeholder="Введите автора...">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Текст в описании</label>
                            <input type="text" class="form-control form-control-sm" name="description_text" value="{{ filters.description_text }}" 
                                   placeholder="Слово или фраза из описания...">
                        </div>
                    </div>

                    <!-- Параметры танца -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3 border-bottom pb-2">Параметры танца</h6>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label small">Тактов в танце</label>
                                <input type="number" class="form-control form-control-sm" name="size_min" value="{{ filters.size_min }}" 
                                       placeholder="Мин." min="0">
                            </div>
                            <div class="col-6">
                                <label class="form-label small">Повторений</label>
                                <input type="number" class="form-control form-control-sm" name="count_min" value="{{ filters.count_min }}" 
                                       placeholder="Мин." min="0">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small">Тип танца</label>
                            <select class="form-select form-select-sm search-select" name="dance_types" multiple size="5">
                                {% for dance_type in dance_types %}
                                <option value="{{ dance_type.id }}" 
                                        {% if dance_type.id|string in filters.dance_types %}selected{% endif %}>
                                    {{ dance_type.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Для выбора нескольких удерживайте Ctrl</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small">Формат сета</label>
                            <select class="form-select form-select-sm search-select" name="dance_formats" multiple size="5">
                                {% for dance_format in dance_formats %}
                                <option value="{{ dance_format.id }}" 
                                        {% if dance_format.id|string in filters.dance_formats %}selected{% endif %}>
                                    {{ dance_format.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Для выбора нескольких удерживайте Ctrl</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small">Тип сета</label>
                            <select class="form-select form-select-sm search-select" name="set_types" multiple size="5">
                                {% for set_type in set_types %}
                                <option value="{{ set_type.id }}" 
                                        {% if set_type.id|string in filters.set_types %}selected{% endif %}>
                                    {{ set_type.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Для выбора нескольких удерживайте Ctrl</div>
                        </div>
                    </div>

                    <!-- Дополнительные фильтры -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3 border-bottom pb-2">Дополнительно</h6>
                        <div class="mb-3">
                            <label class="form-label small">Танцующие пары</label>
                            <select class="form-select form-select-sm search-select" name="dance_couples" multiple size="5">
                                {% for couple_value, couple_display in dance_couples %}
                                <option value="{{ couple_value }}" 
                                        {% if couple_value in filters.dance_couples %}selected{% endif %}>
                                    {{ couple_display }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Для выбора нескольких удерживайте Ctrl</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small">Наличие материалов</label>
                            <div class="ps-2">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="has_description" 
                                           id="hasDescription" value="on" {% if filters.has_description %}checked{% endif %}>
                                    <label class="form-check-label small" for="hasDescription">
                                        Есть описание
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" name="has_files" 
                                           id="hasFiles" value="on" {% if filters.has_files %}checked{% endif %}>
                                    <label class="form-check-label small" for="hasFiles">
                                        Есть диаграммы
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="rscds" 
                                           id="rscds" value="on" {% if filters.rscds %}checked{% endif %}>
                                    <label class="form-check-label small" for="rscds">
                                        Публикация RSCDS
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Кнопки управления -->
                    <div class="border-top pt-3">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="fas fa-search me-2"></i>Найти танцы
                            </button>
                            <a href="{{ url_for('advanced_search') }}" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-undo me-2"></i>Сбросить фильтры
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Правая колонка - Результаты -->
    <div class="col-lg-9">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-dark text-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Результаты поиска</h5>
                    {% if results and pagination and search_performed %}
                    <span class="badge bg-primary">{{ pagination.total }} найдено</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="card-body">
                {% if not search_performed %}
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Задайте параметры поиска</h5>
                    <p class="text-muted mb-0">Используйте фильтры слева для поиска танцев и нажмите кнопку "Найти танцы"</p>
                </div>
                {% elif results %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0 table-compact fixed-columns">
                        <thead class="table-dark">
                            <tr>
                                <th width="50" class="text-center">ID</th>
                                <th width="280">Название и автор</th>
                                <th width="120">Тип</th>
                                <th width="130">Формат сета</th>
                                <th width="130">Тип сета</th>
                                <th width="100">Размер</th>
                                <th width="90" class="text-center">Материалы</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dance in results %}
                            <tr class="align-middle">
                                <td class="ps-3 text-muted small">{{ dance.id }}</td>
                                <td>
                                    <div class="d-flex flex-column">
                                        <a href="{{ url_for('view_dance', dance_id=dance.id) }}" 
                                           class="text-decoration-none fw-bold dance-name text-truncate"
                                           title="{{ dance.name }}">
                                            {{ dance.name }}
                                        </a>
                                        {% if dance.author %}
                                        <small class="text-muted author-text text-truncate" title="{{ dance.author }}">
                                            {{ dance.author }}
                                        </small>
                                        {% endif %}
                                    </div>
                                </td>
                                <!-- Тип танца -->
                                <td>
                                    {% if dance.dance_type %}
                                        <span class="badge badge-type 
                                            {% if dance.dance_type.name == 'Reel' %}bg-reel
                                            {% elif dance.dance_type.name == 'Jig' %}bg-jig
                                            {% elif dance.dance_type.name == 'Strathspey' %}bg-strathspey
                                            {% elif dance.dance_type.name == 'Medley' %}bg-medley
                                            {% elif dance.dance_type.name == 'Polka' %}bg-polka
                                            {% elif dance.dance_type.name == 'March' %}bg-march
                                            {% elif dance.dance_type.name == 'Waltz' %}bg-waltz
                                            {% elif dance.dance_type.name == 'Hornpipe' %}bg-hornpipe
                                            {% elif dance.dance_type.name == 'Quadrille' %}bg-quadrille
                                            {% elif dance.dance_type.name == 'Minuet' %}bg-minuet
                                            {% else %}bg-secondary{% endif %}">
                                            {{ dance.dance_type.name }}
                                        </span>
                                    {% else %}
                                        <span class="badge bg-light text-muted">-</span>
                                    {% endif %}
                                </td>
                                <!-- Формат сета -->
                                <td>
                                    {% if dance.dance_format %}
                                        <span class="dance-format text-truncate d-block" title="{{ dance.dance_format.name }}">
                                            {{ dance.dance_format.name }}
                                        </span>
                                    {% else %}
                                        <span class="dance-format">-</span>
                                    {% endif %}
                                </td>
                                <!-- Тип сета -->
                                <td>
                                    {% if dance.set_type %}
                                        <span class="dance-set-type text-truncate d-block" title="{{ dance.set_type.name }}">
                                            {{ dance.set_type.name }}
                                        </span>
                                    {% else %}
                                        <span class="dance-set-type">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if dance.count_id and dance.size_id %}
                                        <span class="dance-size">
                                            {{ dance.count_id }}×{{ dance.size_id }}
                                        </span>
                                    {% elif dance.size_id %}
                                        <span class="dance-size">
                                            {{ dance.size_id }} тактов
                                        </span>
                                    {% else %}
                                        <span class="dance-size">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <div class="d-flex justify-content-center gap-1">
                                        <!-- Иконка короны для RSCDS танцев -->
                                        {% if dance.rscds %}
                                        <img src="{{ url_for('static', filename='img/crown.png') }}" 
                                             alt="RSCDS" 
                                             class="material-icon" 
                                             title="Танец RSCDS"
                                             style="width: 25px; height: 25px; opacity: 0.8;">
                                        {% endif %}
                                        
                                        <!-- Иконка описания (газета) -->
                                        {% if dance.has_any_description %}
                                        <img src="{{ url_for('static', filename='img/newspaper.png') }}" 
                                             alt="Описание" 
                                             class="material-icon" 
                                             title="Есть описание танца или e-cribs"
                                             style="width: 25px; height: 25px; opacity: 0.8;">
                                        {% endif %}
                                        
                                        <!-- Иконка файлов (картина) -->
                                        {% set dance_files = get_dance_files(dance.id, dance.name) %}
                                        {% set dance_images = get_dance_images(dance.id, dance.name) %}
                                        {% if dance_files or dance_images %}
                                        <img src="{{ url_for('static', filename='img/image.png') }}" 
                                             alt="Файлы" 
                                             class="material-icon" 
                                             title="Есть дополнительные материалы"
                                             style="width: 25px; height: 25px; opacity: 0.8;">
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Танцы не найдены</h5>
                    <p class="text-muted mb-0">Попробуйте изменить параметры поиска</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Пагинация -->
        {% if results and pagination and pagination.pages > 1 and search_performed %}
        <div class="mt-4">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mb-2 pagination-sm">
                    <!-- Первая страница -->
                    {% if pagination.page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="{{ build_pagination_url(1) }}" aria-label="First">
                            <img src="{{ url_for('static', filename='img/double-arrow-left.png') }}" alt="Первая" style="width: 25px; height: 25px;">
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link"><img src="{{ url_for('static', filename='img/double-arrow-left.png') }}" alt="Первая" style="width: 25px; height: 25px; opacity: 0.3;"></span>
                    </li>
                    {% endif %}

                    <!-- Предыдущая страница -->
                    {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ build_pagination_url(pagination.prev_num) }}" aria-label="Previous">
                            <img src="{{ url_for('static', filename='img/arrow-left.png') }}" alt="Предыдущая" style="width: 25px; height: 25px;">
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link"><img src="{{ url_for('static', filename='img/arrow-left.png') }}" alt="Предыдущая" style="width: 25px; height: 25px; opacity: 0.3;"></span>
                    </li>
                    {% endif %}

                    <!-- Номера страниц -->
                    {% if pagination.iter_pages %}
                        {% for page_num in pagination.iter_pages(left_edge=2, left_current=2, right_current=2, right_edge=2) %}
                            {% if page_num %}
                                <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                                    <a class="page-link" href="{{ build_pagination_url(page_num) }}">{{ page_num }}</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    <!-- Следующая страница -->
                    {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ build_pagination_url(pagination.next_num) }}" aria-label="Next">
                            <img src="{{ url_for('static', filename='img/arrow-right.png') }}" alt="Следующая" style="width: 25px; height: 25px;">
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link"><img src="{{ url_for('static', filename='img/arrow-right.png') }}" alt="Следующая" style="width: 25px; height: 25px; opacity: 0.3;"></span>
                    </li>
                    {% endif %}

                    <!-- Последняя страница -->
                    {% if pagination.page < pagination.pages %}
                    <li class="page-item">
                        <a class="page-link" href="{{ build_pagination_url(pagination.pages) }}" aria-label="Last">
                            <img src="{{ url_for('static', filename='img/double-arrow-right.png') }}" alt="Последняя" style="width: 25px; height: 25px;">
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link"><img src="{{ url_for('static', filename='img/double-arrow-right.png') }}" alt="Последняя" style="width: 25px; height: 25px; opacity: 0.3;"></span>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            
            <!-- Информация о пагинации -->
            <div class="text-muted text-center mt-3">
                <small>Показано {{ results|length }} из {{ pagination.total }} танцев (страница {{ pagination.page }} из {{ pagination.pages }})</small>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
/* ===== ФИКСИРОВАННАЯ ШИРИНА СТОЛБЦОВ ===== */
.table-compact.fixed-columns {
    table-layout: fixed;
    width: 100%;
}

/* Принудительная установка ширины для всех столбцов */
.table-compact.fixed-columns th:nth-child(1),
.table-compact.fixed-columns td:nth-child(1) {
    width: 50px;
    min-width: 50px;
    max-width: 50px;
}

.table-compact.fixed-columns th:nth-child(2),
.table-compact.fixed-columns td:nth-child(2) {
    width: 280px;
    min-width: 280px;
    max-width: 280px;
}

.table-compact.fixed-columns th:nth-child(3),
.table-compact.fixed-columns td:nth-child(3) {
    width: 120px;
    min-width: 120px;
    max-width: 120px;
}

.table-compact.fixed-columns th:nth-child(4),
.table-compact.fixed-columns td:nth-child(4) {
    width: 130px;
    min-width: 130px;
    max-width: 130px;
}

.table-compact.fixed-columns th:nth-child(5),
.table-compact.fixed-columns td:nth-child(5) {
    width: 130px;
    min-width: 130px;
    max-width: 130px;
}

.table-compact.fixed-columns th:nth-child(6),
.table-compact.fixed-columns td:nth-child(6) {
    width: 100px;
    min-width: 100px;
    max-width: 100px;
}

.table-compact.fixed-columns th:nth-child(7),
.table-compact.fixed-columns td:nth-child(7) {
    width: 90px;
    min-width: 90px;
    max-width: 90px;
}

/* Обрезка длинного текста */
.table-compact.fixed-columns td {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Специальные стили для колонки с названием и автором */
.table-compact.fixed-columns td:nth-child(2) {
    white-space: normal;
    overflow: hidden;
}

.table-compact.fixed-columns td:nth-child(2) .d-flex {
    min-height: 32px;
    justify-content: center;
    flex-direction: column;
}

/* ===== СТИЛИ ДЛЯ УВЕЛИЧЕННЫХ SELECT-ЭЛЕМЕНТОВ ===== */
.search-select {
    min-height: 120px !important;
    resize: vertical;
}

.search-select option {
    padding: 8px 10px;
    border-bottom: 1px solid #f8f9fa;
    font-size: 0.9rem;
}

.search-select option:hover {
    background-color: #e9ecef;
}

.search-select option:checked {
    background-color: #0d6efd !important;
    color: white !important;
    font-weight: 500;
}

/* ===== СТИЛИ ДЛЯ ИКОНОК МАТЕРИАЛОВ ===== */
.material-icon {
    cursor: default;
    transition: all 0.2s ease;
    opacity: 0.8;
}

.material-icon:hover {
    opacity: 1;
    transform: scale(1.1);
}

/* ===== ВЫРАВНИВАНИЕ ПО ЦЕНТРУ ===== */
.table-compact td.text-center > * {
    justify-content: center;
}

/* ===== КОМПАКТНЫЕ ОТСТУПЫ ДЛЯ ГРУППЫ ИКОНОК ===== */
.d-flex.gap-1 {
    gap: 0.2rem !important;
}

/* ===== ОСНОВНЫЕ СТИЛИ ТАБЛИЦЫ ===== */
.table-compact td {
    padding: 4px 6px;
    font-size: 0.9rem; 
    vertical-align: middle;
    height: 20px;
}

.table-compact th {
    padding: 8px 6px;
    font-size: 0.85rem; 
    vertical-align: middle;
    font-weight: 600;
}

/* ===== СТИЛИ ДЛЯ НАЗВАНИЯ ТАНЦА ===== */
.dance-name {
    font-weight: 600 !important;
    color: var(--primary-color) !important;
    font-size: 1rem;
    line-height: 1.2;
}

.dance-name:hover {
    color: #0a58ca !important;
    text-decoration: underline !important;
}

.author-text {
    font-size: 0.8rem;
    color: #6c757d !important;
    line-height: 1.1;
}

/* ===== СТИЛИ ДЛЯ БЕЙДЖЕЙ ТИПОВ ТАНЦЕВ ===== */
.badge-type {
    font-size: 1rem;
    padding: 0.2rem 0.4rem;
    vertical-align: middle;
    display: inline-block;
    line-height: 1;
    font-weight: 600;
    min-width: 70px;
    text-align: center;
    border-radius: 8px;
}

/* Бледные цвета для типов танцев */
.bg-reel {
    background-color: var(--reel-color) !important;
    color: var(--reel-text) !important;
}

.bg-jig {
    background-color: var(--jig-color) !important;
    color: var(--jig-text) !important;
}

.bg-strathspey {
    background-color: var(--strathspey-color) !important;
    color: var(--strathspey-text) !important;
}

.bg-medley {
    background-color: var(--medley-color) !important;
    color: var(--medley-text) !important;
}

.bg-polka {
    background-color: var(--polka-color) !important;
    color: var(--polka-text) !important;
}

.bg-march {
    background-color: var(--march-color) !important;
    color: var(--march-text) !important;
}

.bg-waltz {
    background-color: var(--waltz-color) !important;
    color: var(--waltz-text) !important;
}

.bg-hornpipe {
    background-color: var(--hornpipe-color) !important;
    color: var(--hornpipe-text) !important;
}

.bg-quadrille {
    background-color: var(--quadrille-color) !important;
    color: var(--quadrille-text) !important;
}

.bg-minuet {
    background-color: var(--minuet-color) !important;
    color: var(--minuet-text) !important;
}

/* ===== СТИЛИ ДЛЯ РАЗМЕРА ТАНЦА ===== */
.dance-size {
    font-size: 1rem;
    vertical-align: middle;
    display: inline-block;
    line-height: 1;
    color: #6c757d;
    font-weight: 500;
}

.dance-format, .dance-set-type {
    font-size: 1rem;
    color: #6c757d;
    font-weight: 500;
}

/* ===== СТИЛИ ДЛЯ ID ТАНЦА ===== */
.text-muted.small {
    font-size: 0.9rem;
    color: #6c757d !important;
}

/* ===== ВЫРАВНИВАНИЕ ЭЛЕМЕНТОВ В ТАБЛИЦЕ ===== */
.table-compact td > * {
    vertical-align: middle;
}

/* ===== АДАПТИВНОСТЬ ===== */
@media (max-width: 991.98px) {
    .col-lg-3 {
        margin-bottom: 1.5rem;
    }
    
    .table-compact td,
    .table-compact th {
        padding: 4px 3px;
        font-size: 0.75rem;
    }
    
    .dance-name {
        font-size: 0.8rem;
    }
    
    .author-text {
        font-size: 0.7rem;
    }
    
    .badge-type {
        font-size: 0.65rem;
        padding: 0.15rem 0.3rem;
        min-width: 65px;
    }

    .material-icon {
        width: 12px !important;
        height: 12px !important;
    }
    
    .search-select {
        min-height: 100px !important;
        font-size: 0.85rem;
    }
}

@media (max-width: 767.98px) {
    .card-body {
        padding: 1rem;
    }
    
    .search-select {
        min-height: 80px !important;
    }
    
    .search-select option {
        padding: 6px 8px;
        font-size: 0.8rem;
    }
}
</style>

<script>
// Скрипт для улучшения UX множественного выбора
document.addEventListener('DOMContentLoaded', function() {
    // Добавляем подсказки для множественного выбора
    const selectElements = document.querySelectorAll('.search-select');
    selectElements.forEach(select => {
        // Показываем количество выбранных элементов
        function updateSelectionCount() {
            const selectedCount = Array.from(select.selectedOptions).length;
            const formText = select.parentElement.querySelector('.form-text');
            if (formText && selectedCount > 0) {
                formText.textContent = `Выбрано: ${selectedCount} (удерживайте Ctrl для множественного выбора)`;
            } else if (formText) {
                formText.textContent = 'Для выбора нескольких удерживайте Ctrl';
            }
        }
        
        select.addEventListener('change', updateSelectionCount);
        updateSelectionCount(); // Инициализация при загрузке
    });
});
</script>
{% endblock %}