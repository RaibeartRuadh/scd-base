{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>–í—Å–µ —Ç–∞–Ω—Ü—ã</h1>
    <div>
        <span class="badge bg-info me-2">{{ db_type }}</span>
        <a href="{{ url_for('add_dance') }}" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Ç–∞–Ω–µ—Ü</a>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
<div class="row mb-4">
    <div class="col-md-6">
        <form method="get" class="row g-2">
    <!--        <div class="col-auto">
                 <label for="per_page" class="col-form-label">–û—Ç–æ–±—Ä–∞–∑–∏—Ç—å:</label>
            </div> -->
            <div class="col-auto">
                <select class="form-select" id="per_page" name="per_page" onchange="this.form.submit()">
                    <option value="25" {% if per_page == 25 %}selected{% endif %}>25 —Å—Ç—Ä–æ–∫</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50 —Å—Ç—Ä–æ–∫</option>
                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100 —Å—Ç—Ä–æ–∫</option>
                </select>
            </div>
            <input type="hidden" name="search" value="{{ search }}">
        </form>
    </div>

</div>

<!-- –§–æ—Ä–º–∞ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è -->
<form id="deleteForm" method="POST" action="{{ url_for('delete_dances') }}">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="toggleSelectAll()">
                <span id="selectAllText">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</span>
            </button>
        </div>
        <div>
            <button type="button" class="btn btn-danger" onclick="confirmDelete()" id="deleteButton" disabled>
                –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
            </button>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Ç–∞–Ω—Ü–µ–≤ -->
    <div class="table-responsive">
        <table class="table table-striped table-hover table-sm">
            <thead class="table-dark">
                <tr>
                    <th width="40">
                        <input type="checkbox" id="selectAll" onchange="toggleAllCheckboxes()">
                    </th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–¢–∏–ø</th>
                    <th>–†–∞–∑–º–µ—Ä</th>
                    <th width="140">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% if dances and dances.items %}
                    {% for dance in dances.items %}
                    <tr>
                        <td>
                            <input type="checkbox" name="dance_ids" value="{{ dance.id }}" class="dance-checkbox" onchange="updateDeleteButton()">
                        </td>
<td>
    <a href="{{ url_for('view_dance', dance_id=dance.id) }}" 
       class="text-decoration-none fw-bold text-dark">
        {{ dance.name }}
    </a>
</td>
                        <td>
                            {% if dance.dance_type_rel %}
                                <span class="badge 
                                    {% if dance.dance_type_rel.name == 'Reel' %}bg-primary
                                    {% elif dance.dance_type_rel.name == 'Jig' %}bg-success
                                    {% elif dance.dance_type_rel.name == 'Strathspey' %}bg-warning
                                    {% else %}bg-secondary{% endif %}">
                                    {{ dance.dance_type_rel.name }}
                                </span>
                            {% else %}
                                <span class="badge bg-secondary">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if dance.count_id and dance.size_id %}
                                {{ dance.count_id }}x{{ dance.size_id }}
                            {% elif dance.size_id %}
                                {{ dance.size_id }} —Ç–∞–∫—Ç–æ–≤
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">

                                
                                <!-- –§–∞–π–ª—ã - –ø–∞–ø–∫–∞ -->
                                <a href="{{ url_for('dance_files', dance_id=dance.id) }}" 
                                   class="btn btn-outline-success btn-icon" 
                                   title="–î–æ–ø–æ–ª–Ω–∏—Ç—å/–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∫ —Ç–∞–Ω—Ü—É">
                                    <i class="fas fa-folder fa-xs"></i>
                                </a>
                                
                                <!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å - –∫–∞—Ä–∞–Ω–¥–∞—à -->
                                <a href="{{ url_for('edit_dance', dance_id=dance.id) }}" 
                                   class="btn btn-outline-primary btn-icon" 
                                   title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                    <i class="fas fa-edit fa-xs"></i>
                                </a>
                                
                                <!-- –£–¥–∞–ª–∏—Ç—å - –∫–æ—Ä–∑–∏–Ω–∞ -->
                                <button type="button" 
                                        class="btn btn-outline-danger btn-icon" 
                                        onclick="confirmSingleDelete({{ dance.id }}, '{{ dance.name|replace("'", "\\'") }}')"
                                        title="–£–¥–∞–ª–∏—Ç—å">
                                    <i class="fas fa-trash fa-xs"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                <tr>
                    <td colspan="5" class="text-center py-4">
                        {% if search %}
                            üé≠ –¢–∞–Ω—Ü—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É "{{ search }}" –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                        {% else %}
                            üìù –¢–∞–Ω—Ü—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. <a href="{{ url_for('add_dance') }}">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Ç–∞–Ω–µ—Ü!</a>
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</form>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
{% if dances and dances.pages > 1 %}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        <!-- –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        {% if dances.page > 1 %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('index', page=1, per_page=per_page, search=search) }}" aria-label="First">
                <span aria-hidden="true">¬´¬´</span>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">¬´¬´</span>
        </li>
        {% endif %}

        <!-- –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        {% if dances.has_prev %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('index', page=dances.prev_num, per_page=per_page, search=search) }}" aria-label="Previous">
                <span aria-hidden="true">¬´</span>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">¬´</span>
        </li>
        {% endif %}

        <!-- –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü -->
        {% if dances.iter_pages %}
            {% for page_num in dances.iter_pages(left_edge=2, left_current=2, right_current=2, right_edge=2) %}
                {% if page_num %}
                    <li class="page-item {% if page_num == dances.page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('index', page=page_num, per_page=per_page, search=search) }}">{{ page_num }}</a>
                    </li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}
        {% endif %}

        <!-- –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        {% if dances.has_next %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('index', page=dances.next_num, per_page=per_page, search=search) }}" aria-label="Next">
                <span aria-hidden="true">¬ª</span>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">¬ª</span>
        </li>
        {% endif %}

        <!-- –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        {% if dances.page < dances.pages %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('index', page=dances.pages, per_page=per_page, search=search) }}" aria-label="Last">
                <span aria-hidden="true">¬ª¬ª</span>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">¬ª¬ª</span>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ -->
{% if dances %}
<div class="text-muted text-center mt-3">
    –ü–æ–∫–∞–∑–∞–Ω–æ {{ dances.items|length }} –∏–∑ {{ dances.total }} —Ç–∞–Ω—Ü–µ–≤
    (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ {{ dances.page }} –∏–∑ {{ dances.pages }})
</div>
{% endif %}

<!-- JavaScript –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞–º–∏ –∏ —É–¥–∞–ª–µ–Ω–∏–µ–º -->
<script>
let allSelected = false;

function toggleAllCheckboxes() {
    const checkboxes = document.querySelectorAll('.dance-checkbox');
    const selectAll = document.getElementById('selectAll');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    allSelected = selectAll.checked;
    document.getElementById('selectAllText').textContent = allSelected ? '–°–Ω—è—Ç—å –≤—Å–µ' : '–í—ã–±—Ä–∞—Ç—å –≤—Å–µ';
    updateDeleteButton();
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    selectAll.checked = !allSelected;
    toggleAllCheckboxes();
}

function updateDeleteButton() {
    const checkboxes = document.querySelectorAll('.dance-checkbox:checked');
    const deleteButton = document.getElementById('deleteButton');
    
    if (checkboxes.length > 0) {
        deleteButton.disabled = false;
        deleteButton.textContent = `–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (${checkboxes.length})`;
    } else {
        deleteButton.disabled = true;
        deleteButton.textContent = '–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ';
    }
}

function confirmDelete() {
    const checkboxes = document.querySelectorAll('.dance-checkbox:checked');
    const count = checkboxes.length;
    
    if (count === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–Ω—Ü—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
        return;
    }
    
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${count} —Ç–∞–Ω—Ü–µ–≤?`)) {
        document.getElementById('deleteForm').submit();
    }
}

function confirmSingleDelete(danceId, danceName) {
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–∞–Ω–µ—Ü "${danceName}"?`)) {
        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ñ–æ—Ä–º—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ —Ç–∞–Ω—Ü–∞
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{{ url_for('delete_single_dance', dance_id=0) }}".replace('0', danceId);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    updateDeleteButton();
});
</script>
{% endblock %}